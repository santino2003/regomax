<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= title %> - Regomax</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Flatpickr - Selector de fechas -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="/assets/css/home.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/home">
                <img src="/assets/img/regomax.png" alt="Regomax Logo" class="bg-white rounded p-1">
                <span class="ms-2 fw-bold">Regomax S.A.</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item user-welcome me-3">
                        <span class="text-light">BIENVENIDO/A, <b><%= username %></b></span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/home"><i class="bi bi-house-door me-1"></i> Inicio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-key me-1"></i> Cambiar contraseña</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="logout-link"><i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4">
        <div class="row mb-4">
            <div class="col">
                <div class="menu-container p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="menu-heading mb-0">
                            <i class="bi bi-truck me-2"></i>Carga de NFU (Neumáticos Fuera de Uso)
                        </h4>
                        
                        <div class="btn-group" role="group">
                            <a href="/reportes/planificar-mes" class="btn btn-outline-primary">
                                <i class="bi bi-calendar me-2"></i>Planificar Mes
                            </a>
                            <a href="/reportes/ver" class="btn btn-outline-primary">
                                <i class="bi bi-graph-up me-2"></i>Ver Reportes
                            </a>
                        </div>
                    </div>
                    
                    <!-- Alertas -->
                    <div id="alertContainer"></div>
                    
                    <div class="row">
                        <div class="col-lg-6 mx-auto">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="card-title mb-0">
                                        <i class="bi bi-input-cursor-text me-2"></i>Ingreso de NFU
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="formCargarNFU">
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label for="fecha" class="form-label">Fecha <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-calendar-date"></i></span>
                                                    <input type="text" class="form-control" id="fecha" name="fecha" value="<%= fecha %>" required>
                                                </div>
                                                <div class="form-text">Seleccione la fecha para la que registra el ingreso</div>
                                            </div>
                                            
                                            <div class="col-md-6">
                                                <label for="cantidad" class="form-label">Cantidad NFU (kg) <span class="text-danger">*</span></label>
                                                <div class="input-group">
                                                    <span class="input-group-text"><i class="bi bi-truck"></i></span>
                                                    <input type="number" class="form-control" id="cantidad" name="cantidad" 
                                                        step="0.01" min="0" required
                                                        <% if (datosCargados && datosCargados.cantidad) { %>
                                                            value="<%= datosCargados.cantidad %>"
                                                        <% } %>>
                                                    <span class="input-group-text">kg</span>
                                                </div>
                                                <div class="form-text">Ingrese la cantidad de neumáticos recibidos en kilogramos</div>
                                            </div>
                                        </div>
                                        
                                        <div class="mt-4">
                                            <% if (datosCargados && datosCargados.id) { %>
                                                <div class="alert alert-info">
                                                    <i class="bi bi-info-circle me-2"></i>
                                                    Ya existen datos para esta fecha. Al guardar, se actualizará el registro existente.
                                                </div>
                                            <% } %>
                                            
                                            <div class="d-grid">
                                                <button type="submit" class="btn btn-primary" id="btnGuardar">
                                                    <i class="bi bi-save me-2"></i>Guardar Registro
                                                </button>
                                            </div>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col">
                <a href="/home" class="btn btn-secondary">
                    <i class="bi bi-arrow-left me-2"></i>Volver al panel
                </a>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <!-- Flatpickr JS -->
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    
    <!-- Common JS -->
    <script src="/assets/js/common.js"></script>
    
    <!-- Custom JS for this page -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar selector de fecha
            const fechaPicker = flatpickr("#fecha", {
                dateFormat: "Y-m-d",
                locale: "es",
                altInput: true,
                altFormat: "d/m/Y",
                maxDate: "today",
                onChange: function(selectedDates, dateStr, instance) {
                    // Redirigir a la misma página con la fecha seleccionada como parámetro
                    if (dateStr) {
                        window.location.href = `/reportes/cargar-nfu?fecha=${dateStr}`;
                    }
                }
            });
            
            // Manejar el envío del formulario
            document.getElementById('formCargarNFU').addEventListener('submit', function(e) {
                e.preventDefault();
                
                // Obtener datos del formulario
                const fecha = document.getElementById('fecha').value;
                const cantidad = parseFloat(document.getElementById('cantidad').value);
                
                // Validar datos
                if (!fecha) {
                    showAlert('Debe seleccionar una fecha', 'danger');
                    return;
                }
                
                if (isNaN(cantidad) || cantidad < 0) {
                    showAlert('La cantidad debe ser un número positivo', 'danger');
                    return;
                }
                
                // Datos a enviar
                const data = {
                    fecha: fecha,
                    cantidad: cantidad
                };
                
                // Deshabilitar botón durante el envío
                const btnGuardar = document.getElementById('btnGuardar');
                btnGuardar.disabled = true;
                btnGuardar.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Guardando...';
                
                // Enviar al servidor
                fetch('/api/reportes/nfu', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Datos guardados correctamente', 'success');
                        
                        // Recargar la página para mostrar los datos actualizados
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    } else {
                        showAlert('Error al guardar: ' + data.message, 'danger');
                        // Restaurar botón
                        btnGuardar.disabled = false;
                        btnGuardar.innerHTML = '<i class="bi bi-save me-2"></i>Guardar Registro';
                    }
                })
                .catch(error => {
                    showAlert('Error de conexión: ' + error.message, 'danger');
                    // Restaurar botón
                    btnGuardar.disabled = false;
                    btnGuardar.innerHTML = '<i class="bi bi-save me-2"></i>Guardar Registro';
                });
            });
            
            // Mostrar alerta
            function showAlert(message, type) {
                const alertHTML = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                        ${message}
                        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                    </div>
                `;
                document.getElementById('alertContainer').innerHTML = alertHTML;
                
                // Auto-ocultar después de 5 segundos
                setTimeout(() => {
                    const alert = document.querySelector('.alert');
                    if (alert) {
                        const bsAlert = new bootstrap.Alert(alert);
                        bsAlert.close();
                    }
                }, 5000);
            }
        });
    </script>
</body>
</html>