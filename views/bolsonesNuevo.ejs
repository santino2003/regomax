<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nuevo Bolsón - Regomax</title>
    
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Custom styles -->
    <link rel="stylesheet" href="/assets/css/home.css">
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary">
        <div class="container-fluid">
            <a class="navbar-brand d-flex align-items-center" href="/home">
                <img src="/assets/img/regomax.png" alt="Regomax Logo" class="bg-white rounded p-1">
                <span class="ms-2 fw-bold">Regomax S.A.</span>
            </a>
            
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item user-welcome me-3">
                        <span class="text-light">BIENVENIDO/A, <b><%= username %></b></span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-globe me-1"></i> Ver sitio</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#"><i class="bi bi-key me-1"></i> Cambiar contraseña</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/logout" id="logout-link"><i class="bi bi-box-arrow-right me-1"></i> Cerrar sesión</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container my-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <div class="menu-container p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4 class="menu-heading mb-0">
                            <i class="bi bi-plus-circle me-2"></i>Crear Nuevo Bolsón
                        </h4>
                        <a href="/bolsones" class="btn btn-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Volver a lista
                        </a>
                    </div>
                    
                    <!-- Alert para mensajes -->
                    <div id="alertContainer"></div>
                    
                    <!-- Formulario -->
                    <form id="formNuevoBolson">
                        <div class="row g-3">
                            <!-- Producto -->
                            <div class="col-md-6">
                                <label for="producto" class="form-label">
                                    <i class="bi bi-box me-1"></i>Producto *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="producto" 
                                       name="producto" 
                                       required 
                                       placeholder="Ingrese el nombre del producto">
                                <div class="invalid-feedback">
                                    Por favor ingrese el producto.
                                </div>
                            </div>
                            
                            <!-- Peso -->
                            <div class="col-md-6">
                                <label for="peso" class="form-label">
                                    <i class="bi bi-speedometer me-1"></i>Peso (kg) *
                                </label>
                                <input type="number" 
                                       class="form-control" 
                                       id="peso" 
                                       name="peso" 
                                       step="0.01" 
                                       min="0" 
                                       required 
                                       placeholder="0.00">
                                <div class="invalid-feedback">
                                    Por favor ingrese un peso válido.
                                </div>
                            </div>
                            
                            <!-- Precinto -->
                            <div class="col-12">
                                <label for="precinto" class="form-label">
                                    <i class="bi bi-lock me-1"></i>Precinto *
                                </label>
                                <input type="text" 
                                       class="form-control" 
                                       id="precinto" 
                                       name="precinto" 
                                       required 
                                       placeholder="Ingrese el número de precinto">
                                <div class="invalid-feedback">
                                    Por favor ingrese el precinto.
                                </div>
                            </div>
                        </div>
                        
                        <!-- Botones -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="d-flex gap-2">
                                    <button type="submit" class="btn btn-primary" id="btnGuardar">
                                        <i class="bi bi-save me-2"></i>Crear Bolsón
                                    </button>
                                    <button type="reset" class="btn btn-outline-secondary">
                                        <i class="bi bi-arrow-clockwise me-2"></i>Limpiar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    
    <script>
        $(document).ready(function() {
            // Función para mostrar alertas con imagen
            function showAlert(message, type = 'success', imageData = null) {
                let alertContent = `
                    <div class="alert alert-${type} alert-dismissible fade show" role="alert">
                        <i class="bi bi-${type === 'success' ? 'check-circle' : 'exclamation-triangle'} me-2"></i>
                        ${message}
                `;
                
                // Si hay imagen, agregarla
                if (imageData && type === 'success') {
                    alertContent += `
                        <div class="text-center mt-3">
                            <hr>
                            <h6><i class="bi bi-upc-scan me-2"></i>Código de Barras Generado:</h6>
                            <img src="data:image/png;base64,${imageData.barcodeBase64}" 
                                 alt="Código de barras ${imageData.codigo}" 
                                 class="img-fluid mb-2" 
                                 style="max-width: 300px; border: 1px solid #dee2e6; padding: 10px; background: white;">
                            <br>
                            <strong>Código: ${imageData.codigo}</strong>
                            <br>
                            <div class="mt-2">
                                <button onclick="descargarImagen('${imageData.barcodeBase64}', '${imageData.codigo}')" 
                                        class="btn btn-sm btn-outline-primary me-2">
                                    <i class="bi bi-download me-1"></i>Descargar PNG
                                </button>
                                <button onclick="imprimirCodigo('${imageData.barcodeBase64}', '${imageData.codigo}')" 
                                        class="btn btn-sm btn-outline-secondary">
                                    <i class="bi bi-printer me-1"></i>Imprimir
                                </button>
                            </div>
                        </div>
                    `;
                }
                
                alertContent += `
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>
                `;
                
                $('#alertContainer').html(alertContent);
                
            }
            
            // Función para descargar imagen
            window.descargarImagen = function(base64Data, codigo) {
                const link = document.createElement('a');
                link.href = `data:image/png;base64,${base64Data}`;
                link.download = `barcode_${codigo}.png`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };
            
            // Función para imprimir código
            window.imprimirCodigo = function(base64Data, codigo) {
                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <html>
                        <head>
                            <title>Código de Barras - ${codigo}</title>
                            <style>
                                body { 
                                    margin: 0; 
                                    padding: 20px; 
                                    text-align: center; 
                                    font-family: Arial, sans-serif; 
                                }
                                img { 
                                    max-width: 100%; 
                                    border: 1px solid #ccc; 
                                    padding: 10px; 
                                }
                                h3 { margin: 10px 0; }
                                @media print {
                                    body { margin: 0; padding: 10px; }
                                }
                            </style>
                        </head>
                        <body>
                            <h3>Bolsón - Código: ${codigo}</h3>
                            <img src="data:image/png;base64,${base64Data}" alt="Código de barras ${codigo}">
                            <p>Generado el: ${new Date().toLocaleString()}</p>
                        </body>
                    </html>
                `);
                printWindow.document.close();
                printWindow.print();
            };
            
            // Manejar envío del formulario
            $('#formNuevoBolson').on('submit', function(e) {
                e.preventDefault();
                
                // Validar formulario
                if (!this.checkValidity()) {
                    e.stopPropagation();
                    $(this).addClass('was-validated');
                    return;
                }
                
                // Obtener datos del formulario
                const formData = {
                    producto: $('#producto').val().trim(),
                    peso: parseFloat($('#peso').val()),
                    precinto: $('#precinto').val().trim()
                };
                
                // Deshabilitar botón durante la operación
                const $btnGuardar = $('#btnGuardar');
                $btnGuardar.prop('disabled', true).html('<i class="bi bi-hourglass-split me-2"></i>Creando...');
                
                // Enviar datos al servidor
                fetch('/api/bolsones/nuevo', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        // Mostrar alerta con imagen
                        showAlert(
                            `¡Bolsón creado exitosamente! Código: <strong>${data.data.codigo}</strong>`, 
                            'success', 
                            data.data
                        );
                        
                        // Limpiar formulario
                        this.reset();
                        $(this).removeClass('was-validated');
                        
                        
                    } else {
                        showAlert('Error: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Error de conexión al crear el bolsón', 'danger');
                })
                .finally(() => {
                    // Rehabilitar botón
                    $btnGuardar.prop('disabled', false).html('<i class="bi bi-save me-2"></i>Crear Bolsón');
                });
            });
            
            // Validación en tiempo real
            $('#producto, #peso, #precinto').on('input', function() {
                if (this.checkValidity()) {
                    $(this).removeClass('is-invalid').addClass('is-valid');
                } else {
                    $(this).removeClass('is-valid').addClass('is-invalid');
                }
            });
            
            // Focus en el primer campo
            $('#producto').focus();
        });
    </script>
</body>
</html>